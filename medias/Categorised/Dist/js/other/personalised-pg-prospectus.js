const path="prod"===UoS_env.name?"/research/hub/test/pgpdf/":"",renderSubjectSelectItems=e=>e.map(e=>"<option>"+e.subject+"</option>").join(""),renderSubjectCoursesOptions=(t,a,e)=>{return e.filter(e=>e.subject===t)[0].courses.map(e=>{var t=e.replaceAll(" ","-").toLowerCase();return'<div class="u-flex u-mb-1"><input class="u-m-0" type="checkbox" id="'+t+'" name="courses_'+a+'" value="'+t+'"><label for="'+t+'">'+e+"</label></div>"}).join("")},renderLink=e=>`<div class="u-bg-energy-purple--10 u-p-3 u-mt-2">
                    <h3>Download your prospectus</h3>
                    <p>
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6" style="width:22px;height:22px;">
                        <path stroke-linecap="round" stroke-linejoin="round" d="m4.5 12.75 6 6 9-13.5" />
                    </svg>
                    Your prospectus has been successfully generated</p>
                    <p><a href="${e}" class="button heritage-green u-inline-block u-mt-2">Download your prospectus</a></p>
            </div>`,renderGenerating=()=>`<div class="u-bg-energy-purple--10 u-p-3 u-mt-2">
                <h3>Download your prospectus</h3>
                <p>Building your pdf...</p>
            </div>`,setDOMContent=stir.curry((e,t)=>(stir.setHTML(e,t),!0));function b64toBlob(e,t,a){var r=atob(e),s=[];for(let e=0;e<r.length;e+=a){var n=r.slice(e,e+a),o=new Array(n.length);for(let e=0;e<n.length;e++)o[e]=n.charCodeAt(e);var i=new Uint8Array(o);s.push(i)}return new Blob(s,{type:t})}async function storePDF(e,t,a){var t=t+".pdf",r=supabase.createClient("https://scezmsgewfitcalrkauq.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNjZXptc2dld2ZpdGNhbHJrYXVxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MTU3NzY4ODQsImV4cCI6MjAzMTM1Mjg4NH0.-WZyB91qB-6PinAYDKT1ziWK3hNRB6GNZTTnVfvHDts"),e=b64toBlob(e,"application/pdf",512),r=(await r.storage.from("pdfs").upload(t,e,{cacheControl:"3600",upsert:!1}))["data"];return r||null}async function createPdf(e,t){var a=stir.node("#resultBox"),r=(setDOMContent(a,renderGenerating()),a.scrollIntoView(),e.get("full_prospectus")),s=e.get("first_name")||"",n=e.get("last_name")||"",o=e.get("email")||"",i=e.get("subject_area_1")||"",c=e.get("subject_area_2")||"",e=e.get("subject_area_3")||"",d=await PDFLib.PDFDocument.create(),u=t+"rawpdfs/full-non-personalised.pdf",l=t+"rawpdfs/Front.pdf",p=t+"rawpdfs/Intro.pdf",f=t+"rawpdfs/IntroInsert.pdf",g=t+"rawpdfs/Back.pdf",i=t+"rawpdfs/"+i.replaceAll(",","")+".pdf",c=t+"rawpdfs/"+c.replaceAll(",","")+".pdf",e=t+"rawpdfs/"+e.replaceAll(",","")+".pdf",n=s+n+String(Date.now())+String(Math.floor(100*Math.random())),b="dev"===UoS_env.name?"GeneralSans-Semibold.otf":'<t4 type="media" id="179150" formatter="path/*"/>',b=await fetch(b).then(e=>e.arrayBuffer()),b=(d.registerFontkit(fontkit),await d.embedFont(b));if("1"===r)await fetch(u).then(e=>e.arrayBuffer()),setDOMContent(a,renderLink("rawpdfs/full-non-personalised.pdf",t));else{for(var h,r=await fetch(l).then(e=>e.arrayBuffer()),u=await PDFLib.PDFDocument.load(r),[l]=await d.copyPages(u,[0]),r=(l.drawText(s.toUpperCase(),{x:93,y:530,size:66,font:b,color:PDFLib.rgb(.99,.99,.99),rotate:PDFLib.degrees(0)}),d.addPage(l),await fetch(f).then(e=>e.arrayBuffer())),u=await PDFLib.PDFDocument.load(r),[w]=await d.copyPages(u,[0]),l=(w.drawText(s.toUpperCase(),{x:45,y:767,size:40,font:b,color:PDFLib.rgb(0,.4,.21),rotate:PDFLib.degrees(0)}),await fetch(p).then(e=>e.arrayBuffer())),D=await PDFLib.PDFDocument.load(l),P=D.getPages(),m=0;m<P.length;)2===m?d.addPage(w):([h]=await d.copyPages(D,[m]),d.addPage(h)),m++;f=t+"rawpdfs/.pdf";if(i!=f)for(var r=await fetch(i).then(e=>e.arrayBuffer()),j=await PDFLib.PDFDocument.load(r),F=j.getPages(),m=0;m<F.length;){var[v]=await d.copyPages(j,[m]);d.addPage(v),m++}if(c!=f)for(var u=await fetch(c).then(e=>e.arrayBuffer()),y=await PDFLib.PDFDocument.load(u),_=y.getPages(),m=0;m<_.length;){var[L]=await d.copyPages(y,[m]);d.addPage(L),m++}if(e!=f)for(var b=await fetch(e).then(e=>e.arrayBuffer()),S=await PDFLib.PDFDocument.load(b),B=S.getPages(),m=0;m<B.length;){var[I]=await d.copyPages(S,[m]);d.addPage(I),m++}for(var p=await fetch(g).then(e=>e.arrayBuffer()),C=await PDFLib.PDFDocument.load(p),M=C.getPages(),m=0;m<M.length;){var[k]=await d.copyPages(C,[m]);d.addPage(k),m++}l="https://scezmsgewfitcalrkauq.supabase.co/storage/v1/object/public/"+(await storePDF(await d.saveAsBase64({dataUri:!1}),n,t)).fullPath;setDOMContent(a,renderLink(l)),emailUser(s,o,l,t)}}async function emailUser(e,t,a,r){var s=new FormData;s.append("pdfPath",a),s.append("firstName",e),s.append("email",t);try{var n=await fetch(r+"app2.php",{method:"POST",body:s});console.log(await n.json())}catch(e){console.error(e)}}const generatePDFBtn=stir.node("#generatePDFBtn"),generatePDFForm=stir.node("#generatePDFForm"),selects=stir.nodes("select"),subjectSelect=(selects.forEach(e=>e.value=""),stir.nodes(".subjectSelect"));subjectSelect[0].insertAdjacentHTML("beforeend",renderSubjectSelectItems(subjectsData)),generatePDFForm&&generatePDFForm.addEventListener("change",function(e){e.preventDefault();var t=new FormData(generatePDFForm),a=t.get("study_year");const r=t.get("subject_area_1"),s=t.get("subject_area_2");t=t.get("subject_area_3");a&&stir.node(".subject_area_1").classList.remove("hide"),"subject_area_1"===e.target.id&&r&&(stir.node("#subject_area_1_courses").innerHTML=renderSubjectCoursesOptions(r,"1",subjectsData),stir.node(".subject_area_2").classList.remove("hide"),a=subjectsData.filter(e=>e.subject!==r),subjectSelect[1].insertAdjacentHTML("beforeend",renderSubjectSelectItems(a))),"subject_area_2"===e.target.id&&s&&(stir.node("#subject_area_2_courses").innerHTML=renderSubjectCoursesOptions(s,"2",subjectsData),stir.node(".subject_area_3").classList.remove("hide"),a=subjectsData.filter(e=>e.subject!==s&&e.subject!==r),subjectSelect[2].insertAdjacentHTML("beforeend",renderSubjectSelectItems(a))),"subject_area_3"===e.target.id&&t&&(stir.node("#subject_area_3_courses").innerHTML=renderSubjectCoursesOptions(t,"3",subjectsData))}),generatePDFBtn&&generatePDFBtn.addEventListener("click",function(e){e.preventDefault(),createPdf(new FormData(generatePDFForm),path)});
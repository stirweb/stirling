const path="prod"===UoS_env.env_name?"/research/hub/test/":"",renderSubjectSelectItems=e=>e.map(e=>"<option>"+e.subject+"</option>").join(""),renderSubjectCoursesOptions=(t,a,e)=>{return e.filter(e=>e.subject===t)[0].courses.map(e=>{var t=e.replaceAll(" ","-").toLowerCase();return'<div class="u-flex u-mb-1"><input class="u-m-0" type="checkbox" id="'+t+'" name="courses_'+a+'" value="'+t+'"><label for="'+t+'">'+e+"</label></div>"}).join("")},renderLink=(e,t)=>`<p><a href="${t+e}.pdf">View and download your personalised PDF</a></p>`,setDOMContent=stir.curry((e,t)=>(stir.setHTML(e,t),!0));async function storePDF(e,t,a){var r=new FormData;r.append("pdf",e),r.append("file_name",t);try{var s=await fetch(a+"app2.php",{method:"POST",body:r});console.log(await s.json())}catch(e){console.error(e)}}async function createPdf(e,t){console.log(e);var a=e.get("full_prospectus"),r=e.get("first_name")||"",s=e.get("last_name")||"",n=e.get("subject_area_1")||"",o=e.get("subject_area_2")||"",e=e.get("subject_area_3")||"",c=await PDFLib.PDFDocument.create(),i=t+"rawpdfs/full-non-personalised.pdf",d=t+"rawpdfs/Front.pdf",u=t+"rawpdfs/Intro.pdf",f=t+"rawpdfs/IntroInsert.pdf",l=t+"rawpdfs/Back.pdf",n=t+"rawpdfs/"+n.replaceAll(",","")+".pdf",o=t+"rawpdfs/"+o.replaceAll(",","")+".pdf",e=t+"rawpdfs/"+e.replaceAll(",","")+".pdf",s=r+s+String(Date.now())+String(Math.floor(100*Math.random())),g="prod"===UoS_env.env_name?'<t4 type="media" id="179150" formatter="path/*"/>':"GeneralSans-Semibold.otf",g=(console.log(g),await fetch(g).then(e=>e.arrayBuffer())),g=(c.registerFontkit(fontkit),await c.embedFont(g));if("1"===a){for(var a=await fetch(i).then(e=>e.arrayBuffer()),p=await PDFLib.PDFDocument.load(a),b=p.getPages(),P=0;P<b.length;){var[D]=await c.copyPages(p,[P]);c.addPage(D),P++}const x=await c.saveAsBase64({dataUri:!1});storePDF(x,s,t),void setDOMContent(stir.node("#resultBox"),renderLink(s,t))}else{for(var w,i=await fetch(d).then(e=>e.arrayBuffer()),a=await PDFLib.PDFDocument.load(i),[d]=await c.copyPages(a,[0]),i=(d.drawText(r.toUpperCase(),{x:93,y:530,size:66,font:g,color:PDFLib.rgb(.99,.99,.99),rotate:PDFLib.degrees(0)}),c.addPage(d),await fetch(f).then(e=>e.arrayBuffer())),a=await PDFLib.PDFDocument.load(i),[F]=await c.copyPages(a,[0]),d=(F.drawText(r.toUpperCase(),{x:45,y:767,size:40,font:g,color:PDFLib.rgb(0,.4,.21),rotate:PDFLib.degrees(0)}),await fetch(u).then(e=>e.arrayBuffer())),j=await PDFLib.PDFDocument.load(d),_=j.getPages(),P=0;P<_.length;)2===P?c.addPage(F):([w]=await c.copyPages(j,[P]),c.addPage(w)),P++;f=t+"rawpdfs/.pdf";if(n!=f)for(var i=await fetch(n).then(e=>e.arrayBuffer()),h=await PDFLib.PDFDocument.load(i),m=h.getPages(),P=0;P<m.length;){var[v]=await c.copyPages(h,[P]);c.addPage(v),P++}if(o!=f)for(var a=await fetch(o).then(e=>e.arrayBuffer()),y=await PDFLib.PDFDocument.load(a),L=y.getPages(),P=0;P<L.length;){var[S]=await c.copyPages(y,[P]);c.addPage(S),P++}if(e!=f)for(var r=await fetch(e).then(e=>e.arrayBuffer()),B=await PDFLib.PDFDocument.load(r),M=B.getPages(),P=0;P<M.length;){var[C]=await c.copyPages(B,[P]);c.addPage(C),P++}for(var g=await fetch(l).then(e=>e.arrayBuffer()),T=await PDFLib.PDFDocument.load(g),A=T.getPages(),P=0;P<A.length;){var[k]=await c.copyPages(T,[P]);c.addPage(k),P++}const x=await c.saveAsBase64({dataUri:!1});storePDF(x,s,t),setDOMContent(stir.node("#resultBox"),renderLink(s,t))}}const generatePDFBtn=stir.node("#generatePDFBtn"),generatePDFForm=stir.node("#generatePDFForm"),selects=stir.nodes("select"),subjectSelect=(selects.forEach(e=>e.value=""),stir.nodes(".subjectSelect"));subjectSelect[0].insertAdjacentHTML("beforeend",renderSubjectSelectItems(subjectsData)),generatePDFForm&&generatePDFForm.addEventListener("change",function(e){e.preventDefault();var t=new FormData(generatePDFForm),a=t.get("study_year");const r=t.get("subject_area_1"),s=t.get("subject_area_2");t=t.get("subject_area_3");a&&stir.node(".subject_area_1").classList.remove("hide"),"subject_area_1"===e.target.id&&r&&(stir.node("#subject_area_1_courses").innerHTML=renderSubjectCoursesOptions(r,"1",subjectsData),stir.node(".subject_area_2").classList.remove("hide"),a=subjectsData.filter(e=>e.subject!==r),subjectSelect[1].insertAdjacentHTML("beforeend",renderSubjectSelectItems(a))),"subject_area_2"===e.target.id&&s&&(stir.node("#subject_area_2_courses").innerHTML=renderSubjectCoursesOptions(s,"2",subjectsData),stir.node(".subject_area_3").classList.remove("hide"),a=subjectsData.filter(e=>e.subject!==s&&e.subject!==r),subjectSelect[2].insertAdjacentHTML("beforeend",renderSubjectSelectItems(a))),"subject_area_3"===e.target.id&&t&&(stir.node("#subject_area_3_courses").innerHTML=renderSubjectCoursesOptions(t,"3",subjectsData))}),generatePDFBtn&&generatePDFBtn.addEventListener("click",function(e){e.preventDefault(),createPdf(new FormData(generatePDFForm),path)});
const serverPath="prod"===UoS_env.name?"/research/hub/test/pgpdf/":"",SUPABASE_URL="https://kkiqupbzfaghcmmacixr.supabase.co",renderSubjectSelectItems=e=>e.map(e=>'<option value="'+e.subject+'">'+e.subject+"</option>").join(""),renderSubjectCoursesOptions=(t,a,e)=>{return e.filter(e=>e.subject===t)[0].courses.map(e=>{var t=e.name.replaceAll(" ","-").toLowerCase();return`<div class="u-flex u-mb-1"><input class="u-m-0" type="checkbox" id="${t}" name="subject_course_${a}" value="${e.name}" data-id="subject_course_${a}" data-type="subject_course"><label for="${t}">${e.name}</label></div>`}).join("")},renderLink=e=>`<div class="u-bg-energy-purple--10 u-p-3 u-mt-2">
            <h3>Download your prospectus</h3>
            <p class="u-flex u-gap-8 align-middle">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6" style="width:24px;height:24px;">
                    <path stroke-linecap="round" stroke-linejoin="round" d="m4.5 12.75 6 6 9-13.5" />
                </svg>
                Your prospectus has been successfully generated</p>
            <p><a href="${e}" class="button heritage-green u-inline-block u-mt-2">Download your prospectus</a></p>
          </div>`,renderGenerating=()=>`<div class="u-bg-energy-purple--10 u-p-3 u-mt-2">
            <h3>Download your prospectus</h3>
            <p>Building your pdf...</p>
          </div>`,renderRequiredError=()=>'<p class="u-p-2 u-heritage-berry text-center u-heritage-berry u-border-solid u-bg-white" >Please ensure you have completed all required fields</p>',getSubjectFileName=(t,e)=>{e=e.filter(e=>e.id===Number(t));return e.length?e[0].subject.replaceAll(",",""):""},setDOMContent=stir.curry((e,t)=>(stir.setHTML(e,t),!0));function b64toBlob(e,t,a){var r=atob(e),s=[];for(let e=0;e<r.length;e+=a){var n=r.slice(e,e+a),o=new Array(n.length);for(let e=0;e<n.length;e++)o[e]=n.charCodeAt(e);var c=new Uint8Array(o);s.push(c)}return new Blob(s,{type:t})}const getSelectedSubjects=()=>{var e=stir.nodes(".subjectSelect");const a=[];return e.forEach(e=>{for(const t of e.options)t.selected&&a.push(t.value)}),a.filter(e=>e).map(e=>({StudyLevel:"Postgraduate",Faculty:e,Course:""}))},getSelectedCourses=()=>stir.nodes('input[data-type="subject_course"]:checked').map(e=>({StudyLevel:"Postgraduate",Faculty:"",Course:e.value}));async function storePDF(e,t,a){var t=t+".pdf",r=supabase.createClient(SUPABASE_URL,"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtraXF1cGJ6ZmFnaGNtbWFjaXhyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MTg5MDEwNjEsImV4cCI6MjAzNDQ3NzA2MX0.qvfBzihxwwWTzsS6BV2CDVcW2nfEGxGUqMjdrQbYnlA"),e=b64toBlob(e,"application/pdf",512),r=(await r.storage.from("pdfs").upload(t,e,{cacheControl:"3600",upsert:!1}))["data"];return r||null}async function submitData(e,t,a){a.append("pdfPath",e);e=[...getSelectedCourses(),...getSelectedSubjects()];a.append("courses",JSON.stringify(e));try{var r=await fetch(t+"app.php",{method:"POST",body:a});console.log(await r.json())}catch(e){console.error(e)}}async function doPdf(e,t,a){var r=stir.node("#resultBox"),s=(setDOMContent(r,renderGenerating()),r.scrollIntoView(),t.get("full_prospectus")),n=t.get("first_name")||"",o=t.get("last_name")||"",c=getSubjectFileName(t.get("subject_area_1"),e),i=getSubjectFileName(t.get("subject_area_2"),e),e=getSubjectFileName(t.get("subject_area_3"),e),u=await PDFLib.PDFDocument.create(),d=a+"rawpdfs/Front.pdf",l=a+"rawpdfs/Intro.pdf",p=a+"rawpdfs/IntroInsert.pdf",f=a+"rawpdfs/Back.pdf",c=a+"rawpdfs/"+c.replaceAll(",","")+".pdf",i=a+"rawpdfs/"+i.replaceAll(",","")+".pdf",e=a+"rawpdfs/"+e.replaceAll(",","")+".pdf",o=String(Date.now()+"--"+n+o+String(Math.floor(100*Math.random()))),g="dev"===UoS_env.name?"GeneralSans-Semibold.otf":'<t4 type="media" id="179150" formatter="path/*"/>',g=await fetch(g).then(e=>e.arrayBuffer()),g=(u.registerFontkit(fontkit),await u.embedFont(g));if("1"===s)s=a+"rawpdfs/full-non-personalised.pdf",setDOMContent(r,renderLink(s)),submitData(s,a,t);else{for(var b,s=await fetch(d).then(e=>e.arrayBuffer()),d=await PDFLib.PDFDocument.load(s),[s]=await u.copyPages(d,[0]),d=11<n.length?40:66,d=(s.drawText(n.toUpperCase(),{x:93,y:530,size:d,font:g,color:PDFLib.rgb(.99,.99,.99),rotate:PDFLib.degrees(0)}),u.addPage(s),await fetch(p).then(e=>e.arrayBuffer())),s=await PDFLib.PDFDocument.load(d),[h]=await u.copyPages(s,[0]),p=(h.drawText(n.toUpperCase(),{x:45,y:767,size:40,font:g,color:PDFLib.rgb(0,.4,.21),rotate:PDFLib.degrees(0)}),await fetch(l).then(e=>e.arrayBuffer())),m=await PDFLib.PDFDocument.load(p),w=m.getPages(),j=0;j<w.length;)2===j?u.addPage(h):([b]=await u.copyPages(m,[j]),u.addPage(b)),j++;d=a+"rawpdfs/.pdf";if(c!=d)for(var s=await fetch(c).then(e=>e.arrayBuffer()),D=await PDFLib.PDFDocument.load(s),P=D.getPages(),j=0;j<P.length;){var[v]=await u.copyPages(D,[j]);u.addPage(v),j++}if(i!=d)for(var n=await fetch(i).then(e=>e.arrayBuffer()),y=await PDFLib.PDFDocument.load(n),F=y.getPages(),j=0;j<F.length;){var[S]=await u.copyPages(y,[j]);u.addPage(S),j++}if(e!=d)for(var g=await fetch(e).then(e=>e.arrayBuffer()),_=await PDFLib.PDFDocument.load(g),L=_.getPages(),j=0;j<L.length;){var[C]=await u.copyPages(_,[j]);u.addPage(C),j++}for(var l=await fetch(f).then(e=>e.arrayBuffer()),B=await PDFLib.PDFDocument.load(l),A=B.getPages(),j=0;j<A.length;){var[I]=await u.copyPages(B,[j]);u.addPage(I),j++}p=await storePDF(await u.saveAsBase64({dataUri:!1}),o,a),c=p?SUPABASE_URL+"/storage/v1/object/public/"+p.fullPath:"";c?(setDOMContent(r,renderLink(c)),submitData(c,a,t)):console.log("Error uploading to Supabase!")}}async function doCaptcha(e,t){t.append("token",e);try{var a,r;return"true"!==(await(await fetch(serverPath+"verify.php",{method:"POST",body:t})).json()).success?(console.log("Captcha - suspected spam"),!1):((a=stir.nodes("[data-required]")).map(e=>e.name).forEach(e=>{stir.node("[data-alertlabel="+e+"]").innerText=" *"}),(r=a.filter(e=>""===e.value)).length?(r.map(e=>e.name).forEach(e=>{stir.node("[data-alertlabel="+e+"]").innerText=" * This field is required"}),setDOMContent(stir.node("#formErrors"),renderRequiredError()),void stir.node("#formErrors").scrollIntoView()):(doPdf(subjectsData,t,serverPath),!0))}catch(e){return console.log("Error with captcha check"),!1}}const generatePDFBtn=stir.node("#generatePDFBtn"),generatePDFForm=stir.node("#generatePDFForm"),selects=stir.nodes("select"),subjectSelect=(selects.forEach(e=>e.value=""),stir.nodes(".subjectSelect"));subjectSelect[0].insertAdjacentHTML("beforeend",renderSubjectSelectItems(subjectsData)),generatePDFForm&&generatePDFForm.addEventListener("change",function(e){e.preventDefault();var t=new FormData(generatePDFForm),a=t.get("study_year");const r=t.get("subject_area_1"),s=t.get("subject_area_2");t=t.get("subject_area_3");a&&stir.node(".subject_area_1").classList.remove("hide"),"subject_area_1"===e.target.id&&r&&(console.log(r),stir.node("#subject_area_1_courses").innerHTML=renderSubjectCoursesOptions(r,"1",subjectsData),stir.node(".subject_area_2").classList.remove("hide"),a=subjectsData.filter(e=>e.subject!==r),subjectSelect[1].insertAdjacentHTML("beforeend",renderSubjectSelectItems(a))),"subject_area_2"===e.target.id&&s&&(stir.node("#subject_area_2_courses").innerHTML=renderSubjectCoursesOptions(s,"2",subjectsData),stir.node(".subject_area_3").classList.remove("hide"),a=subjectsData.filter(e=>e.subject!==s&&e.subject!==r),subjectSelect[2].insertAdjacentHTML("beforeend",renderSubjectSelectItems(a))),"subject_area_3"===e.target.id&&t&&(stir.node("#subject_area_3_courses").innerHTML=renderSubjectCoursesOptions(t,"3",subjectsData))}),generatePDFBtn&&generatePDFBtn.addEventListener("click",function(e){e.preventDefault();const t=new FormData(generatePDFForm);grecaptcha.execute("6LeLc_wpAAAAAK9XBEY5HhZcsYEgTTi1wukDL685",{action:"register"}).then(function(e){doCaptcha(e,t)})});
const serverPath="prod"===UoS_env.name?"/research/hub/test/pgpdf/":"",renderSubjectSelectItems=e=>e.map(e=>'<option value="'+e.subject+'">'+e.subject+"</option>").join(""),renderSubjectCoursesOptions=(t,a,e)=>{return e.filter(e=>e.subject===t)[0].courses.map(e=>{var t=e.name.replaceAll(" ","-").toLowerCase();return`<div class="u-flex u-mb-1"><input class="u-m-0" type="checkbox" id="${t}" name="subject_course_${a}" value="${e.name}" data-id="subject_course_${a}" data-type="subject_course"><label for="${t}">${e.name}</label></div>`}).join("")},renderLink=e=>""===e?"Your file has downloaded. Please check your downloads folder":`<a href="${e}" target="_blank" class="button heritage-green u-inline-block u-mt-2">Download your prospectus</a>`,renderLinkBox=e=>`<div class="u-bg-energy-purple--10 u-p-3 u-mt-2">
            <h3>Download your prospectus</h3>
            <p class="u-flex u-gap-8 align-middle">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6" style="width:24px;height:24px;">
                    <path stroke-linecap="round" stroke-linejoin="round" d="m4.5 12.75 6 6 9-13.5" />
                </svg>
                Your prospectus has been successfully generated</p>
                <p>${renderLink(e)}</p>
          </div>`,renderGenerating=()=>`<div class="u-bg-energy-purple--10 u-p-3 u-mt-2">
            <h3>Download your prospectus</h3>
            <p>Building your pdf...</p>
          </div>`,renderRequiredError=()=>'<p class="u-p-2 u-heritage-berry text-center u-heritage-berry u-border-solid u-bg-white" >Please ensure you have completed all required fields</p>',setDOMContent=stir.curry((e,t)=>(stir.setHTML(e,t),!0)),getSubjectID=stir.curry((e,t)=>{e=e.filter(e=>e.subject===t);return e.length?e[0].id:""}),getSubjectFromID=stir.curry((e,t)=>{e=e.filter(e=>e.id===Number(t));return e.length?e[0].subject:""});function storePDF2(e,t,a){var r,e=""+e;if(!window.ActiveXObject)return(r=document.createElement("a")).href=e,r.target="_blank",e.substring(e.lastIndexOf("/")+1),r.download="YourPersonalisedPGPerspectus.pdf",navigator.userAgent.toLowerCase().match(/(ipad|iphone|safari)/)&&navigator.userAgent.search("Chrome")<0?(console.log("Safari"),r):(e=new MouseEvent("click",{view:window,bubbles:!0,cancelable:!1}),r.dispatchEvent(e),(window.URL||window.webkitURL).revokeObjectURL(r.href),"")}function b64toBlob(e,t,a){var r=atob(e),s=[];for(let e=0;e<r.length;e+=a){var n=r.slice(e,e+a),o=new Array(n.length);for(let e=0;e<n.length;e++)o[e]=n.charCodeAt(e);var c=new Uint8Array(o);s.push(c)}return new Blob(s,{type:t})}const getSelectedSubjects=()=>{var e=stir.nodes(".subjectSelect");const a=[];return e.forEach(e=>{for(const t of e.options)t.selected&&a.push(t.value)}),a.filter(e=>e).map(e=>({StudyLevel:"Postgraduate",Faculty:e,Course:""}))},getSelectedCourses=()=>stir.nodes('input[data-type="subject_course"]:checked').map(e=>({StudyLevel:"Postgraduate",Faculty:"",Course:e.value}));async function submitData(e,t,a){a.append("pdfPath",e);e=[...getSelectedCourses(),...getSelectedSubjects()];a.append("courses",JSON.stringify(e));try{var r=await fetch(t+"app.php",{method:"POST",body:a});console.log(await r.json())}catch(e){console.error(e)}}async function doPdf(e,t,a){var r="https://www.stir.ac.uk/study/postgraduate/create-your-personalised-prospectus/welcome-back/",s=stir.node("#resultBox"),n=(setDOMContent(s,renderGenerating()),s.scrollIntoView(),t.get("full_prospectus")),o=t.get("first_name")||"",c=t.get("email")||"",i=t.get("subject_area_1"),u=t.get("subject_area_2"),d=t.get("subject_area_3"),l=await PDFLib.PDFDocument.create(),p=a+"rawpdfs/Front.pdf",f=a+"rawpdfs/Intro.pdf",g=a+"rawpdfs/IntroInsert.pdf",b=a+"rawpdfs/Back.pdf",h=a+"rawpdfs/"+i.replaceAll(",","")+".pdf",w=a+"rawpdfs/"+u.replaceAll(",","")+".pdf",m=a+"rawpdfs/"+d.replaceAll(",","")+".pdf",P="dev"===UoS_env.name?"GeneralSans-Semibold.otf":'<t4 type="media" id="179150" formatter="path/*"/>',P=await fetch(P).then(e=>e.arrayBuffer()),P=(l.registerFontkit(fontkit),await l.embedFont(P));if("1"===n)n=r+`?n=${window.btoa(t.get("first_name"))}&s=&f=1}`,j=a+"rawpdfs/full-non-personalised.pdf",c&&submitData(n,a,t),setDOMContent(s,renderLinkBox(j));else{for(var D,n=await fetch(p).then(e=>e.arrayBuffer()),j=await PDFLib.PDFDocument.load(n),[p]=await l.copyPages(j,[0]),n=11<o.length?40:66,j=(p.drawText(o.toUpperCase(),{x:93,y:530,size:n,font:P,color:PDFLib.rgb(.99,.99,.99),rotate:PDFLib.degrees(0)}),l.addPage(p),await fetch(g).then(e=>e.arrayBuffer())),n=await PDFLib.PDFDocument.load(j),[y]=await l.copyPages(n,[0]),p=(y.drawText(o.toUpperCase(),{x:45,y:767,size:40,font:P,color:PDFLib.rgb(0,.4,.21),rotate:PDFLib.degrees(0)}),await fetch(f).then(e=>e.arrayBuffer())),v=await PDFLib.PDFDocument.load(p),F=v.getPages(),_=0;_<F.length;)2===_?l.addPage(y):([D]=await l.copyPages(v,[_]),l.addPage(D)),_++;g=a+"rawpdfs/.pdf";if(h!=g)for(var j=await fetch(h).then(e=>e.arrayBuffer()),S=await PDFLib.PDFDocument.load(j),L=S.getPages(),_=0;_<L.length;){var[k]=await l.copyPages(S,[_]);l.addPage(k),_++}if(w!=g)for(var n=await fetch(w).then(e=>e.arrayBuffer()),C=await PDFLib.PDFDocument.load(n),B=C.getPages(),_=0;_<B.length;){var[x]=await l.copyPages(C,[_]);l.addPage(x),_++}if(m!=g)for(var o=await fetch(m).then(e=>e.arrayBuffer()),A=await PDFLib.PDFDocument.load(o),O=A.getPages(),_=0;_<O.length;){var[I]=await l.copyPages(A,[_]);l.addPage(I),_++}for(var P=await fetch(b).then(e=>e.arrayBuffer()),E=await PDFLib.PDFDocument.load(P),T=E.getPages(),_=0;_<T.length;){var[M]=await l.copyPages(E,[_]);l.addPage(M),_++}f=b64toBlob(await l.saveAsBase64({dataUri:!1}),"application/pdf",512),p=URL.createObjectURL(f),h=[getSubjectID(e,i),getSubjectID(e,u),getSubjectID(e,d)].filter(e=>Number(e)),j=r+`?n=${window.btoa(t.get("first_name"))}&f=0&s=`+h.join(","),w=(c&&submitData(j,a,t),stir.node("#pgstudent"));w&&setDOMContent(w,t.get("first_name")),setDOMContent(s,renderLinkBox(p))}}async function doCaptcha(e,t){t.append("token",e);try{var a,r;return"true"!==(await(await fetch(serverPath+"verify.php",{method:"POST",body:t})).json()).success?(console.log("Captcha - suspected spam"),!1):((a=stir.nodes("[data-required]")).map(e=>e.name).forEach(e=>{stir.node("[data-alertlabel="+e+"]").innerText=" *"}),(r=a.filter(e=>""===e.value)).length?(r.map(e=>e.name).forEach(e=>{stir.node("[data-alertlabel="+e+"]").innerText=" * This field is required"}),setDOMContent(stir.node("#formErrors"),renderRequiredError()),void stir.node("#formErrors").scrollIntoView()):(doPdf(subjectsData,t,serverPath),!0))}catch(e){return console.log("Error with captcha check"),!1}}const generatePDFBtn=stir.node("#generatePDFBtn"),generatePDFForm=stir.node("#generatePDFForm");if(generatePDFForm){const E0=stir.nodes("select"),F0=(E0.forEach(e=>e.value=""),stir.nodes(".subjectSelect"));F0[0]&&F0[0].insertAdjacentHTML("beforeend",renderSubjectSelectItems(subjectsData)),generatePDFForm&&generatePDFForm.addEventListener("change",function(e){e.preventDefault();var t=new FormData(generatePDFForm);const a=t.get("subject_area_1"),r=t.get("subject_area_2");var s,t=t.get("subject_area_3");"subject_area_1"===e.target.id&&a&&(stir.node("#subject_area_1_courses").innerHTML=renderSubjectCoursesOptions(a,"1",subjectsData),s=subjectsData.filter(e=>e.subject!==a),F0[1].insertAdjacentHTML("beforeend",renderSubjectSelectItems(s))),"subject_area_2"===e.target.id&&r&&(stir.node("#subject_area_2_courses").innerHTML=renderSubjectCoursesOptions(r,"2",subjectsData),s=subjectsData.filter(e=>e.subject!==r&&e.subject!==a),F0[2].insertAdjacentHTML("beforeend",renderSubjectSelectItems(s))),"subject_area_3"===e.target.id&&t&&(stir.node("#subject_area_3_courses").innerHTML=renderSubjectCoursesOptions(t,"3",subjectsData))}),generatePDFBtn&&generatePDFBtn.addEventListener("click",function(e){e.preventDefault();const t=new FormData(generatePDFForm);grecaptcha.execute(CAPTCHA,{action:"register"}).then(function(e){doCaptcha(e,t)})})}const cleanse=e=>e.replaceAll("script>","").replaceAll("script%3E","").replaceAll("<","");if(stir.node("#doStoredPDF")){let t="";try{t=window.atob(QueryParams.get("n")?QueryParams.get("n"):"")}catch(e){t=""}const V0=cleanse(t),W0=cleanse(QueryParams.get("s")?QueryParams.get("s"):""),X0=cleanse(QueryParams.get("f")?QueryParams.get("f"):""),Y0=getSubjectFromID(subjectsData),Z0=W0.split(",").map(e=>Y0(e)).filter(e=>e),$0=V0.length||Z0.length?X0:"1",_0=new FormData(doStoredPDF);_0.append("first_name",V0),_0.append("full_prospectus",$0),_0.append("subject_area_1",Z0[0]||""),_0.append("subject_area_2",Z0[1]||""),_0.append("subject_area_3",Z0[2]||""),doPdf(subjectsData,_0,serverPath)}